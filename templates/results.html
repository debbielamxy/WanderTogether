<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>WanderTogether - Travel Companion Recommendations</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      :root{ --bg:#f7f8fb; --card:#fff; --muted:#6b7280; --accent:#2b6cb0; --high:#16a34a; --mid:#f59e0b; --low:#ef4444; --field:#334155; --answer:#0f172a; --compat-high:#1e40af; --compat-mid:#6366f1; --compat-low:#6b7280 }
      body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;background:var(--bg);color:#0f172a;margin:0;padding:20px}
      .container{max-width:1200px;margin:16px auto}
      h1{font-size:24px;margin:0 0 12px}
      .subtitle{font-size:16px;color:var(--muted);margin-bottom:20px}
      .msg{background:#eef6ff;border-left:4px solid var(--accent);padding:10px;border-radius:6px;margin-bottom:12px;color:#0b4a6f}
      .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:16px}
      .card{background:var(--card);padding:16px;border-radius:10px;box-shadow:0 1px 6px rgba(2,6,23,0.06);display:flex;gap:12px}
      .left{flex:0 0 36px;display:flex;align-items:flex-start}
      .content{flex:1}
      .name{font-size:16px;font-weight:600;margin:0}
      .bio{font-size:13px;color:var(--muted);margin-top:8px}
      .meta-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
      .meta{font-size:13px;color:var(--muted)}
      .badge{font-size:12px;padding:4px 8px;border-radius:999px;color:#fff;display:inline-block}
      .alg-label{font-size:11px;color:#6b7280;font-style:italic;margin-top:4px}
      .alg-title{font-size:14px;font-weight:600;color:#374151;margin-bottom:4px}
      /* Trust badge colors */
      .trust-high{background:var(--high)}
      .trust-mid{background:var(--mid)}
      .trust-low{background:var(--low)}
      /* Compatibility badge colors (distinct from trust) */
      .compat-high{background:var(--compat-high)}
      .compat-mid{background:var(--compat-mid)}
      .compat-low{background:var(--compat-low)}
      label.match-row{display:flex;align-items:flex-start;gap:10px}
      input[type=checkbox]{width:20px;height:20px;margin-top:4px}
      button{background:var(--accent);color:#fff;padding:10px 14px;border-radius:8px;border:0;cursor:pointer}
      .small{font-size:13px;color:var(--muted)}
      .score-display{display:flex;gap:8px;align-items:center;margin-top:8px}
      .score-label{font-size:11px;color:var(--muted)}
    </style>
  </head>
  <body>
    <div style="text-align:center;margin-bottom:24px">
      <img src="/static/app_logo.png" alt="WanderTogether Logo" style="max-width:350px;height:auto;border-radius:8px" />
    </div>
    {% if message %}
      <div class="msg">{{ message }}</div>
    {% endif %}
    
    <div class="container">
      {# maps to display friendly labels for pace and style #}
      {% set pace_map = {1:'Relaxed itinerary',2:'Spontaneous/No itinerary',3:'Packed itinerary'} %}
      {% set style_map = {'economical':'Economical','average':'Average','luxury':'Luxury'} %}
      
      <div style="margin-bottom:16px;text-align:center" class="small">
        <strong>Trust Score:</strong> Reliability based on past interactions and verification status. &nbsp;&nbsp;&nbsp;&nbsp; <strong>Compatibility Score:</strong> How well travel preferences align with yours.
      </div>

    <form id="matchesForm">
      <!-- user hidden fields -->
      <input type="hidden" name="session_id" value="{{ session_id }}" />
      <input type="hidden" name="name" value="{{ user.name }}" />
      <input type="hidden" name="age" value="{{ user.age }}" />
      <input type="hidden" name="gender" value="{{ user.gender }}" />
      <input type="hidden" name="budget" value="{{ user.budget }}" />
      <input type="hidden" name="travel_budget" value="{{ user.travel_budget if user.travel_budget is defined else user.budget }}" />
      <input type="hidden" name="cleanliness" value="{{ user.cleanliness }}" />
      <input type="hidden" name="dietary" value="{{ user.dietary }}" />
      <input type="hidden" name="alcohol" value="{{ user.alcohol }}" />
      <input type="hidden" name="smoking" value="{{ user.smoking }}" />
      <input type="hidden" name="fitness" value="{{ user.fitness }}" />
      <input type="hidden" name="pace" value="{{ user.pace }}" />
      <input type="hidden" name="pace_text" value="{{ user.pace_text }}" />
      <input type="hidden" name="style" value="{{ user.style }}" />
      {% for it in user.interests %}
        <input type="hidden" name="interests" value="{{ it }}" />
      {% endfor %}
      {% for s in user.sleep %}
        <input type="hidden" name="sleep" value="{{ s }}" />
      {% endfor %}
      <input type="hidden" name="bio" value="{{ user.bio }}" />

      <div class="grid">
      {% for profile, final_score, compatibility_score in recommendations %}
        <div class="card">
          <label class="match-row">
            <div class="left">
              <input type="checkbox" name="selected" value="{{ profile.id }}::{{ '%.4f'|format(final_score) }}::{{ '%.4f'|format(compatibility_score) }}::{{ '%.4f'|format(profile.trust if profile.trust is defined else 0.5) }}">
            </div>
            <div class="content">
              <div class="name">
                {{ profile.name }}
                <span style="font-weight:400;font-size:13px;color:var(--muted);margin-left:8px">Â· Age: {{ profile.age if profile.age is defined else 'â€”' }}</span>
              </div>
              
              <div class="bio">{{ profile.bio }}</div>
              
              <!-- Travel Preferences Section -->
              <div class="travel-preferences" id="travel-{{ profile.id }}">
                <div class="meta-row">
                  <div class="meta"><span style="color:var(--field);font-weight:600">Pace:</span> {{ pace_map[profile.pace] if profile.pace in pace_map else profile.pace }}</div>
                  <div class="meta"><span style="color:var(--field);font-weight:600">Style:</span> {{ style_map[profile.style] if profile.style in style_map else profile.style }}</div>
                </div>
                
                {% if profile.interests and profile.interests|length > 0 %}
                  <div class="meta-row">
                    <div class="meta"><span style="color:var(--field);font-weight:600">Interests:</span> {{ profile.interests[:3]|join(', ') }}{% if profile.interests|length > 3 %}...{% endif %}</div>
                  </div>
                {% endif %}
                
                <div class="meta-row">
                  <div class="meta"><span style="color:var(--field);font-weight:600">Sleeping:</span> {% if profile.sleep and profile.sleep|length > 0 %}{{ profile.sleep | join(', ') }}{% else %}â€”{% endif %}</div>
                  <div class="meta"><span style="color:var(--field);font-weight:600">Cleanliness:</span> {% if profile.cleanliness and profile.cleanliness not in ['none', 'no'] %}{{ profile.cleanliness }}{% else %}â€”{% endif %}</div>
                </div>
                
                <div class="meta-row">
                  <div class="meta"><span style="color:var(--field);font-weight:600">Dietary:</span> {% if profile.dietary and profile.dietary not in ['none', 'no'] %}{{ profile.dietary }}{% else %}â€”{% endif %}</div>
                  <div class="meta"><span style="color:var(--field);font-weight:600">Alcohol:</span> {% if profile.alcohol and profile.alcohol not in ['none', 'no'] %}{{ profile.alcohol }}{% else %}â€”{% endif %}</div>
                </div>
                
                <div class="meta-row">
                  <div class="meta"><span style="color:var(--field);font-weight:600">Smoking:</span> {% if profile.smoking and profile.smoking not in ['none', 'no'] %}{{ profile.smoking }}{% else %}â€”{% endif %}</div>
                  <div class="meta"><span style="color:var(--field);font-weight:600">Fitness:</span> {% if profile.fitness and profile.fitness not in ['none', 'no'] %}{{ profile.fitness }}{% else %}â€”{% endif %}</div>
                </div>
              </div>
              
              <!-- Contact Information Section (Initially Hidden) -->
              <div class="contact-info" id="contact-{{ profile.id }}" style="display: none;">
                <div class="meta-row" style="background:#f0f9ff;padding:8px;border-radius:6px;border-left:3px solid #0ea5e9;">
                  <div class="meta" style="font-weight:600;color:#0c4a6e;">ðŸ“ž Contact:</div>
                  <div class="meta" style="color:#0c4a6e;">{{ profile.contact }}</div>
                </div>
              </div>
              
              <div class="score-display" style="display:flex;gap:16px;align-items:center;justify-content:space-between">
                <div style="display:flex;gap:8px;align-items:center">
                  <div class="score-label">Trust:</div>
                  {% set trust_val = (profile.trust if profile.trust is defined else 0.5) %}
                  {% if trust_val >= 0.85 %}
                    <div class="badge trust-high" title="Verified profile with strong reliability indicators and positive travel history">High Trust</div>
                  {% elif trust_val >= 0.65 %}
                    <div class="badge trust-mid" title="Profile shows reasonable reliability; some trust indicators still developing">Moderate Trust</div>
                  {% elif trust_val >= 0.40 %}
                    <div class="badge trust-low" title="Limited trust signals available; proceed with standard precautions">Basic Trust</div>
                  {% else %}
                    <div class="badge trust-low" style="background:#6b7280" title="Insufficient or concerning trust indicators; caution strongly advised">Low Trust</div>
                  {% endif %}
                </div>
                
                <div style="display:flex;gap:8px;align-items:center">
                  <div class="score-label">Compatibility:</div>
                  {% set compat_val = compatibility_score if compatibility_score is defined else 0.0 %}
                  {% if compat_val >= 0.80 %}
                    <div class="badge compat-high" title="Strong alignment in travel style, interests, and preferences">Excellent Match</div>
                  {% elif compat_val >= 0.60 %}
                    <div class="badge compat-mid" style="background:#14b8a6" title="Good overall alignment with minor differences">Good Match</div>
                  {% elif compat_val >= 0.40 %}
                    <div class="badge compat-low" title="Some shared interests, but notable differences in travel preferences">Fair Match</div>
                  {% else %}
                    <div class="badge compat-low" style="background:#6b7280" title="Limited alignment; travel expectations may differ significantly">Low Match</div>
                  {% endif %}
                </div>
              </div>
            </div>
          </label>
        </div>
      {% endfor %}
      </div>

      <div style="margin-top:20px;text-align:center">
        <button type="button">Match!</button>
        <div class="small" style="margin-top:8px">Select one or more travel companions you'd like to journey with</div>
      </div>
    </form>
    </div>

    <script>
      // Limit checkbox selections to 6
      document.querySelectorAll('input[name="selected"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const checked = document.querySelectorAll('input[name="selected"]:checked');
          if (checked.length > 6) {
            this.checked = false;
            alert('You can select up to 6 companions only.');
          }
        });
      });

      // Handle Match! button click
      const matchButton = document.querySelector('button[type="button"]');
      if (matchButton) {
        matchButton.addEventListener('click', function(e) {
        e.preventDefault(); // Prevent form submission
        
        const checked = document.querySelectorAll('input[name="selected"]:checked');
        
        if (checked.length === 0) {
          alert('Please select at least one travel companion.');
          return;
        }
        
        // Toggle contact info for selected companions
        checked.forEach(checkbox => {
          const value = checkbox.value;
          const profileId = value.split('::')[0];
          
          // Hide travel preferences
          const travelSection = document.getElementById('travel-' + profileId);
          if (travelSection) {
            travelSection.style.display = 'none';
          }
          
          // Hide bio description
          const bioSection = checkbox.closest('.card').querySelector('.bio');
          if (bioSection) {
            bioSection.style.display = 'none';
          }
          
          // Show contact information
          const contactSection = document.getElementById('contact-' + profileId);
          if (contactSection) {
            contactSection.style.display = 'block';
          }
        });
        
        // Grey out unselected candidates
        const allCheckboxes = document.querySelectorAll('input[name="selected"]');
        allCheckboxes.forEach(checkbox => {
          if (!checkbox.checked) {
            const card = checkbox.closest('.card');
            if (card) {
              card.style.opacity = '0.3';
              card.style.pointerEvents = 'none';
              checkbox.disabled = true;
            }
          }
        });
        
        // Hide the button and helper text
        const buttonContainer = document.querySelector('div[style*="margin-top:20px;text-align:center"]');
        if (buttonContainer) {
          buttonContainer.style.display = 'none';
        }
        
        // Show completion message
        const completionDiv = document.createElement('div');
        completionDiv.style.marginTop = '20px';
        completionDiv.style.textAlign = 'center';
        completionDiv.style.padding = '16px';
        completionDiv.style.background = '#f0fdf4';
        completionDiv.style.borderRadius = '8px';
        completionDiv.style.borderLeft = '4px solid #16a34a';
        completionDiv.innerHTML = '<div style="color:#166534;font-weight:600;font-size:16px">Matched! Contact and connect with your travel buddy now!</div>';
        
        const form = document.getElementById('matchesForm');
        form.appendChild(completionDiv);
        });
      }
    </script>
  </body>
</html>
